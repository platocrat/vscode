/*
 * Wallaby.js - v1.0.963
 * https://wallabyjs.com
 * Copyright (c) 2014-2020 Wallaby.js - All Rights Reserved.
 *
 * This source code file is a part of Wallaby.js and is a proprietary (closed source) software.

 * IMPORTANT:
 * Wallaby.js is a tool made by software developers for software developers with passion and love for what we do.
 * Pirating the tool is not only illegal and just morally wrong,
 * it is also unfair to other fellow programmers who are using it legally,
 * and very harmful for the tool and its future.
 */
function Runner(e){var t=this;this._globals=[],this._abort=!1,this.suite=e,this.total=e.total(),this.failures=0,this.on("test end",function(e){t.checkGlobals(e)}),this.on("hook end",function(e){t.checkGlobals(e)}),this.grep(/.*/),this.globals(this.globalProps().concat(extraGlobals()))}function filterLeaks(e,t){return filter(t,function(t){if(/^d+/.test(t))return!1;if(global.navigator&&/^getInterface/.test(t))return!1;if(global.navigator&&/^\d+/.test(t))return!1;if(/^mocha-/.test(t))return!1;var i=filter(e,function(e){return~e.indexOf("*")?0==t.indexOf(e.split("*")[0]):t==e});return 0==i.length&&(!global.navigator||"onerror"!==t)})}function extraGlobals(){if("object"==typeof process&&"string"==typeof process.version){var e=process.version.split(".").reduce(function(e,t){return e<<8|t});if(e<2315)return["errno"]}return[]}var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner,Runner.immediately=global.setImmediate||process.nextTick,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(e,t){return debug("grep %s",e),this._grep=e,this._invert=t,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(e){var t=this,i=0;return e.eachTest(function(e){var n=t._grep.test(e.fullTitle());t._invert&&(n=!n),n&&i++}),i},Runner.prototype.globalProps=function(){for(var e=utils.keys(global),t=0;t<globals.length;++t)~utils.indexOf(e,globals[t])||e.push(globals[t]);return e},Runner.prototype.globals=function(e){return 0==arguments.length?this._globals:(debug("globals %j",e),this._globals=this._globals.concat(e),this)},Runner.prototype.checkGlobals=function(e){if(!this.ignoreLeaks){var t,i=this._globals,n=this.globalProps();e&&(i=i.concat(e._allowedGlobals||[])),this.prevGlobalsLength!=n.length&&(this.prevGlobalsLength=n.length,t=filterLeaks(i,n),this._globals=this._globals.concat(t),t.length>1?this.fail(e,new Error("global leaks detected: "+t.join(", "))):t.length&&this.fail(e,new Error("global leak detected: "+t[0])))}},Runner.prototype.fail=function(e,t){++this.failures,e.state="failed","string"==typeof t&&(t=new Error('the string "'+t+'" was thrown, throw an Error :)')),this.emit("fail",e,t)},Runner.prototype.failHook=function(e,t){this.fail(e,t),this.suite.bail()&&this.emit("end")},Runner.prototype.hook=function(e,t){function i(e){var n=r[e];return n?(s.currentRunnable=n,n.ctx.currentTest=s.test,s.emit("hook",n),n.on("error",function(e){s.failHook(n,e)}),void n.run(function(r){n.removeAllListeners("error");var o=n.error();return o&&s.fail(s.test,o),r?(s.failHook(n,r),t(r)):(s.emit("hook end",n),delete n.ctx.currentTest,void i(++e))})):t()}var n=this.suite,r=n["_"+e],s=this;Runner.immediately(function(){i(0)})},Runner.prototype.hooks=function(e,t,i){function n(o){return r.suite=o,o?void r.hook(e,function(e){if(e){var o=r.suite;return r.suite=s,i(e,o)}n(t.pop())}):(r.suite=s,i())}var r=this,s=this.suite;n(t.pop())},Runner.prototype.hookUp=function(e,t){var i=[this.suite].concat(this.parents()).reverse();this.hooks(e,i,t)},Runner.prototype.hookDown=function(e,t){var i=[this.suite].concat(this.parents());this.hooks(e,i,t)},Runner.prototype.parents=function(){for(var e=this.suite,t=[];e=e.parent;)t.push(e);return t},Runner.prototype.runTest=function(e){var t=this.test,i=this;this.asyncOnly&&(t.asyncOnly=!0);try{t.on("error",function(e){i.fail(t,e)}),t.run(e)}catch(n){e(n)}},Runner.prototype.runTests=function(e,t){function i(e,n,r){var o=s.suite;s.suite=r?n.parent:n,s.suite?s.hookUp("afterEach",function(e,r){return s.suite=o,e?i(e,r,!0):void t(n)}):(s.suite=o,t(n))}function n(a,l){if(s.failures&&e._bail)return t();if(s._abort)return t();if(a)return i(a,l,!0);if(r=o.shift(),!r)return t();var c=s._grep.test(r.fullTitle());return s._invert&&(c=!c),c?r.pending?(s.emit("pending",r),s.emit("test end",r),n()):(s.emit("test",s.test=r),void s.hookDown("beforeEach",function(e,t){return e?i(e,t,!1):(s.currentRunnable=s.test,void s.runTest(function(e){return r=s.test,e?(s.fail(r,e),s.emit("test end",r),s.hookUp("afterEach",n)):(r.state="passed",s.emit("pass",r),s.emit("test end",r),void s.hookUp("afterEach",n))}))})):n()}var r,s=this,o=e.tests.slice();this.next=n,n()},Runner.prototype.runSuite=function(e,t){function i(t){if(t)return t==e?n():n(t);if(s._abort)return n();var r=e.suites[o++];return r?void s.runSuite(r,i):n()}function n(i){s.suite=e,s.hook("afterAll",function(){s.emit("suite end",e),t(i)})}var r=this.grepTotal(e),s=this,o=0;return debug("run suite %s",e.fullTitle()),r?(this.emit("suite",this.suite=e),void this.hook("beforeAll",function(t){return t?n():void s.runTests(e,i)})):t()},Runner.prototype.uncaught=function(e){e?debug("uncaught exception %s",e!==function(){return this}.call(e)?e:e.message||e):(debug("uncaught undefined exception"),e=utils.undefinedError()),e.uncaught=!0;var t=this.currentRunnable;if(t){var i=t.state;if(this.fail(t,e),t.clearTimeout(),!i)return"test"==t.type?(this.emit("test end",t),void this.hookUp("afterEach",this.next)):void this.emit("end")}},Runner.prototype.run=function(e){function t(e){i.uncaught(e)}var i=this,e=e||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",t),e(i.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),i.emit("end")}),process.on("uncaughtException",t),this},Runner.prototype.abort=function(){debug("aborting"),this._abort=!0};